#!/usr/bin/env bash
# pre-push hook: Validate HANDOFF.md freshness + quick code checks
# Lenient mode: warns but does NOT block if Ollama is down
# Only blocks on definitive failures (TypeScript compilation errors)

set -euo pipefail

REPO_ROOT=$(git rev-parse --show-toplevel)
HANDOFF_FILE="${REPO_ROOT}/HANDOFF.md"
ERRORS=0
WARNINGS=0

echo "=== Pre-push checks ==="

# 1. Check HANDOFF.md freshness
if [ -f "$HANDOFF_FILE" ]; then
  HANDOFF_COMMIT=$(sed -n 's/^commit: *\([^ ]*\)/\1/p' "$HANDOFF_FILE" 2>/dev/null | head -1)
  HANDOFF_COMMIT="${HANDOFF_COMMIT:-none}"
  CURRENT_COMMIT=$(git rev-parse --short HEAD)
  # Compare - the handoff commit should be recent (within last 2 commits)
  if [ "$HANDOFF_COMMIT" = "none" ]; then
    echo "[WARN] HANDOFF.md has no commit reference"
    WARNINGS=$((WARNINGS + 1))
  fi
  echo "[OK] HANDOFF.md exists (last update: ${HANDOFF_COMMIT})"
else
  echo "[WARN] HANDOFF.md not found - consider running post-commit hook"
  WARNINGS=$((WARNINGS + 1))
fi

# 2. TypeScript compilation check on changed files
CHANGED_TS=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | grep -E '\.(ts|tsx)$' || echo "")
if [ -n "$CHANGED_TS" ]; then
  if command -v npx &>/dev/null && [ -f "${REPO_ROOT}/tsconfig.json" ]; then
    echo "[CHECK] Running TypeScript check..."
    if ! npx tsc --noEmit --pretty 2>&1 | head -20; then
      echo "[FAIL] TypeScript compilation errors found"
      ERRORS=$((ERRORS + 1))
    else
      echo "[OK] TypeScript compilation passed"
    fi
  else
    echo "[SKIP] No tsconfig.json or npx not available"
  fi
else
  echo "[SKIP] No TypeScript files changed"
fi

# 3. Quick Ollama code check (lenient - warn only)
if command -v jq &>/dev/null && command -v curl &>/dev/null; then
  # Auto-detect model
  OLLAMA_MODEL="qwen2.5-coder:7b"
  AVAILABLE_MODELS=$(curl -s --max-time 3 http://localhost:11434/api/tags 2>/dev/null | jq -r '.models[].name' 2>/dev/null || echo "")
  if echo "$AVAILABLE_MODELS" | grep -q "qwen2.5-coder:14b"; then
    OLLAMA_MODEL="qwen2.5-coder:14b"
  elif echo "$AVAILABLE_MODELS" | grep -q "qwen2.5-coder"; then
    OLLAMA_MODEL=$(echo "$AVAILABLE_MODELS" | grep "qwen2.5-coder" | head -1)
  fi

  # Get first 50 lines of up to 5 changed files
  CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | head -5)
  CODE_SNIPPET=""
  FILE_COUNT=0

  while IFS= read -r file; do
    [ -z "$file" ] && continue
    FULL_PATH="${REPO_ROOT}/${file}"
    [ ! -f "$FULL_PATH" ] && continue
    FILE_COUNT=$((FILE_COUNT + 1))
    SNIPPET=$(head -50 "$FULL_PATH" 2>/dev/null || echo "")
    CODE_SNIPPET="${CODE_SNIPPET}
--- ${file} ---
${SNIPPET}
"
  done <<< "$CHANGED_FILES"

  if [ $FILE_COUNT -gt 0 ]; then
    PROMPT_TEXT="Quick code review. Flag only OBVIOUS bugs or security issues (not style). Be very brief.

${CODE_SNIPPET}

If no issues found, respond with just: NO_ISSUES
Otherwise list each issue on one line: FILE:LINE - ISSUE"

    JSON_PAYLOAD=$(jq -n \
      --arg model "$OLLAMA_MODEL" \
      --arg prompt "$PROMPT_TEXT" \
      '{model: $model, prompt: $prompt, stream: false, options: {temperature: 0.1, num_predict: 256}}')

    OLLAMA_RESPONSE=$(curl -s --max-time 12 \
      -X POST http://localhost:11434/api/generate \
      -H "Content-Type: application/json" \
      -d "$JSON_PAYLOAD" 2>/dev/null || echo "")

    if [ -n "$OLLAMA_RESPONSE" ]; then
      REVIEW=$(echo "$OLLAMA_RESPONSE" | jq -r '.response // empty' 2>/dev/null || echo "")
      if [ -n "$REVIEW" ] && ! echo "$REVIEW" | grep -qi "NO_ISSUES"; then
        echo "[WARN] Local model flagged potential issues:"
        echo "$REVIEW" | head -10
        WARNINGS=$((WARNINGS + 1))
      else
        echo "[OK] Local model: no obvious issues"
      fi
    else
      echo "[SKIP] Ollama unavailable - skipping code review"
    fi
  fi
fi

# Summary
echo ""
echo "=== Results: ${ERRORS} errors, ${WARNINGS} warnings ==="

# Only block on definitive errors (TypeScript), not warnings
if [ $ERRORS -gt 0 ]; then
  echo "Push BLOCKED due to errors. Fix and retry."
  exit 1
fi

if [ $WARNINGS -gt 0 ]; then
  echo "Warnings found but push allowed."
fi

exit 0
