---
phase: 01-data-foundation
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - app/_layout.tsx
  - app/(tabs)/index.tsx
  - app/(tabs)/tree.tsx
autonomous: true

must_haves:
  truths:
    - "Stores are initialized when app mounts"
    - "Feed screen reads from feedStore, not local state"
    - "Tree screen reads from familyStore, not local state"
    - "Modifying store state triggers component re-render"
  artifacts:
    - path: "app/_layout.tsx"
      provides: "Store initialization on app mount"
      contains: "loadData"
    - path: "app/(tabs)/index.tsx"
      provides: "Feed screen using feedStore"
      contains: "useFeedStore"
    - path: "app/(tabs)/tree.tsx"
      provides: "Tree screen using familyStore"
      contains: "useFamilyStore"
  key_links:
    - from: "app/_layout.tsx"
      to: "src/stores/index.ts"
      via: "imports and calls loadData"
      pattern: "import.*Store.*from.*stores"
    - from: "app/(tabs)/index.tsx"
      to: "src/stores/feedStore.ts"
      via: "uses useFeedStore hook"
      pattern: "useFeedStore"
    - from: "app/(tabs)/tree.tsx"
      to: "src/stores/familyStore.ts"
      via: "uses useFamilyStore hook"
      pattern: "useFamilyStore"
---

<objective>
Wire screens to use stores and initialize stores on app mount.

Purpose: Connect the React components to the Zustand stores so they have reliable data sources. This completes DATA-03 (screens read from stores) and DATA-04 (store actions update UI).
Output: Screens use stores, stores initialize on mount, UI updates when store state changes.
</objective>

<execution_context>
@./.claude/agents/workflows/execute-plan.md
@./.claude/agents/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-data-foundation/01-CONTEXT.md
@.planning/phases/01-data-foundation/01-02-SUMMARY.md
@.planning/phases/01-data-foundation/01-03-SUMMARY.md
@app/_layout.tsx
@app/(tabs)/index.tsx
@app/(tabs)/tree.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize stores on app mount</name>
  <files>app/_layout.tsx</files>
  <action>
Add store initialization in the root layout.

**Add imports:**
```typescript
import { useEffect } from 'react';
import { useFamilyStore, useUserStore, useFeedStore } from '../src/stores';
```

**Add initialization in RootLayout component:**
```typescript
export default function RootLayout() {
  const loadFamily = useFamilyStore(state => state.loadData);
  const loadUser = useUserStore(state => state.loadData);
  const loadFeed = useFeedStore(state => state.loadData);

  useEffect(() => {
    // Initialize all stores on app mount
    Promise.all([loadFamily(), loadUser(), loadFeed()]);
  }, [loadFamily, loadUser, loadFeed]);

  return (
    // ... existing JSX unchanged
  );
}
```

**Note:** This pattern is from RESEARCH.md. It:
- Initializes stores asynchronously on mount
- Uses Promise.all for parallel loading
- Prepares the app for future Firebase integration
  </action>
  <verify>App launches without errors, stores are populated after mount</verify>
  <done>Stores initialize when app mounts via loadData() calls in useEffect</done>
</task>

<task type="auto">
  <name>Task 2: Wire Feed screen to feedStore</name>
  <files>app/(tabs)/index.tsx</files>
  <action>
Replace local state with feedStore.

**Remove:**
- `useState` import (if only used for feedItems)
- `const [feedItems, setFeedItems] = useState<FeedItemType[]>(mockFeedItems);`
- Local handleHeart function that updates local state

**Add imports:**
```typescript
import { useFeedStore, useUserStore } from '../../src/stores';
```

**Replace with store usage:**
```typescript
const items = useFeedStore(state => state.items);
const toggleHeart = useFeedStore(state => state.toggleHeart);
const isLoading = useFeedStore(state => state.isLoading);
const currentMemberId = useUserStore(state => state.currentMemberId);
```

**Update handleHeart:**
```typescript
const handleHeart = (itemId: string) => {
  if (currentMemberId) {
    toggleHeart(itemId, currentMemberId);
  }
};
```

**Replace `feedItems` with `items`** in FlatList data prop.

**Replace `currentUserId` with `currentMemberId`** where used.

**Optional:** Show loading state while isLoading is true:
```typescript
if (isLoading) {
  return <ActivityIndicator />;
}
```

**Keep:** mockPrompts import for the prompt card, getDailyVerse, and all styling.
  </action>
  <verify>
- Feed screen displays items from store
- Heart toggle updates immediately (optimistic)
- No more local feedItems state
  </verify>
  <done>Feed screen uses useFeedStore for items and toggleHeart, useUserStore for currentMemberId</done>
</task>

<task type="auto">
  <name>Task 3: Wire Tree screen to familyStore</name>
  <files>app/(tabs)/tree.tsx</files>
  <action>
Replace mock data import with familyStore.

**Remove:**
- `import { mockFamilyMembers } from '../../src/utils/mockData';`

**Add imports:**
```typescript
import { useFamilyStore } from '../../src/stores';
```

**Add store usage:**
```typescript
const getMembersByGeneration = useFamilyStore(state => state.getMembersByGeneration);
const isLoading = useFamilyStore(state => state.isLoading);
```

**Update generation filtering:**
Replace inline filter logic with getMembersByGeneration() selector:
```typescript
const grandparents = getMembersByGeneration(0);
const parents = getMembersByGeneration(1);
const children = getMembersByGeneration(2);
```

**Note:** Using getMembersByGeneration() instead of inline filtering fixes an issue where the old filter logic would misclassify Timothy (no 'parent' relationships stored) and Preston (no 'child' relationships stored). The store selector handles this correctly.

**Optional:** Show loading indicator while isLoading:
```typescript
if (isLoading) {
  return <ActivityIndicator />;
}
```

**Keep:** All styling, TreeNode, SpouseConnector, GenerationConnector components, and existing layout logic.
  </action>
  <verify>
- Tree screen displays members from store
- No import from mockData
- Tree still renders correctly with 9 Herman family members
  </verify>
  <done>Tree screen uses useFamilyStore for members data</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run the app on iOS Simulator: `npm run ios`
2. Verify Feed tab shows feed items (from store)
3. Verify Tree tab shows family tree (from store)
4. Tap heart on feed item - verify it toggles immediately
5. Check console for any errors
6. Verify no TypeScript errors: `npx tsc --noEmit`
</verification>

<success_criteria>
- Stores initialize on app mount (useEffect in _layout.tsx)
- Feed screen displays items from useFeedStore
- Feed heart toggle uses store action (optimistic update)
- Tree screen displays members from useFamilyStore
- No local state for feedItems or mockFamilyMembers
- UI updates when store state changes
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-foundation/01-04-SUMMARY.md`
</output>
