---
phase: 01-data-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/stores/familyStore.ts
  - src/stores/userStore.ts
  - src/stores/index.ts
autonomous: true

must_haves:
  truths:
    - "useFamilyStore.loadData() populates members array"
    - "useFamilyStore.getMemberById('eli') returns Eli's member object"
    - "useFamilyStore.calculateRelationship('shelby', 'eli') returns 'Your Mom'"
    - "useUserStore provides current user's member ID"
  artifacts:
    - path: "src/stores/familyStore.ts"
      provides: "Family state management with selectors"
      exports: ["useFamilyStore"]
    - path: "src/stores/userStore.ts"
      provides: "Current user state management"
      exports: ["useUserStore"]
    - path: "src/stores/index.ts"
      provides: "Store exports"
      contains: "useFamilyStore"
  key_links:
    - from: "src/stores/familyStore.ts"
      to: "src/utils/mockData.ts"
      via: "imports mockFamilyMembers"
      pattern: "import.*mockFamilyMembers.*from.*mockData"
    - from: "src/stores/familyStore.ts"
      to: "src/utils/relationships.ts"
      via: "imports calculateRelationship"
      pattern: "import.*calculateRelationship.*from.*relationships"
---

<objective>
Create familyStore and userStore with async loading and selectors.

Purpose: These stores provide the data layer that all screens will read from. They follow the async loadData() pattern for future Firebase compatibility.
Output: Two new Zustand stores with loading states, selectors, and actions.
</objective>

<execution_context>
@./.claude/agents/workflows/execute-plan.md
@./.claude/agents/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-data-foundation/01-CONTEXT.md
@.planning/phases/01-data-foundation/01-RESEARCH.md
@.planning/phases/01-data-foundation/01-01-SUMMARY.md
@src/stores/authStore.ts
@src/stores/feedStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create familyStore with async loading</name>
  <files>src/stores/familyStore.ts</files>
  <action>
Create familyStore following the pattern in RESEARCH.md.

**State interface:**
```typescript
interface FamilyState {
  members: FamilyMember[];
  isLoading: boolean;
  error: string | null;

  // Actions
  loadData: () => Promise<void>;

  // Selectors
  getMemberById: (id: string) => FamilyMember | undefined;
  calculateRelationship: (targetId: string, currentUserId: string) => string;
  getMembersByGeneration: (generation: number) => FamilyMember[];
  getSpouseOf: (memberId: string) => FamilyMember | undefined;
  getChildrenOf: (memberId: string) => FamilyMember[];
  getParentsOf: (memberId: string) => FamilyMember[];
}
```

**loadData implementation:**
- Set isLoading: true, error: null
- Simulate async with 100ms delay (mimics Firebase)
- Import mockFamilyMembers and set to state
- Set isLoading: false on success
- Catch errors and set error message

**calculateRelationship implementation:**
- Takes two parameters: targetId and currentUserId (caller supplies currentUserId)
- If no currentUserId provided, return 'Unknown'
- Call the calculateRelationship utility from relationships.ts
- Pass currentUserId, targetId, and members array
- Note: Caller is responsible for getting currentUserId from userStore. This avoids calling hooks inside store actions (which would crash).

**getMembersByGeneration implementation:**
- Generation 0: members with no parent relationships (grandparents)
- Generation 1: members who have parents AND (have children OR have spouse with children)
- Generation 2: members who have parents but no children
- Note: This is simplified for Herman family structure

**getSpouseOf, getChildrenOf, getParentsOf:**
- Filter relationships array by type
- Return found member(s) using getMemberById

**Pattern to follow:** See existing authStore.ts and feedStore.ts for Zustand create() pattern.
  </action>
  <verify>
```typescript
// In a test file or REPL:
const store = useFamilyStore.getState();
await store.loadData();
console.log(store.members.length); // Should be 9
console.log(store.getMemberById('eli')?.firstName); // Should be 'Eli'
```
  </verify>
  <done>familyStore exports useFamilyStore with loadData action and all specified selectors</done>
</task>

<task type="auto">
  <name>Task 2: Create userStore for current user</name>
  <files>src/stores/userStore.ts</files>
  <action>
Create userStore to hold current user's member ID and preferences.

**State interface:**
```typescript
interface UserPreferences {
  // Placeholder for future preferences
  notificationsEnabled: boolean;
}

interface UserState {
  currentMemberId: string | null;
  preferences: UserPreferences;
  isLoading: boolean;
  error: string | null;

  // Actions
  loadData: () => Promise<void>;
  setCurrentMemberId: (memberId: string | null) => void;
  updatePreferences: (updates: Partial<UserPreferences>) => void;
}
```

**loadData implementation:**
- Set isLoading: true
- Simulate async with 50ms delay
- Set currentMemberId to 'eli' (hardcoded for MVP - Eli is the current user)
- Set default preferences: { notificationsEnabled: true }
- Set isLoading: false

**Rationale for separate userStore (from RESEARCH.md):**
- authStore handles authentication state (login/logout)
- userStore handles current user profile data
- familyStore holds ALL family members including Eli
- currentMemberId in userStore points to Eli's entry in familyStore

**Pattern:** Follow authStore.ts pattern for create() call.
  </action>
  <verify>
```typescript
const userStore = useUserStore.getState();
await userStore.loadData();
console.log(userStore.currentMemberId); // Should be 'eli'
```
  </verify>
  <done>userStore exports useUserStore with loadData action and currentMemberId state</done>
</task>

<task type="auto">
  <name>Task 3: Export new stores from index</name>
  <files>src/stores/index.ts</files>
  <action>
Add exports for the new stores:

```typescript
export { useFamilyStore } from './familyStore';
export { useUserStore } from './userStore';
```

Keep existing exports (useAuthStore, useFeedStore, useSubscriptionStore).
  </action>
  <verify>
```typescript
import { useFamilyStore, useUserStore } from './stores';
// Should import without errors
```
  </verify>
  <done>index.ts exports useFamilyStore and useUserStore</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `npx tsc --noEmit` - no TypeScript errors
2. Import useFamilyStore and useUserStore from '@/stores'
3. Call loadData() on both stores
4. Verify useFamilyStore.getState().members.length === 9
5. Verify useUserStore.getState().currentMemberId === 'eli'
6. Verify useFamilyStore.getState().calculateRelationship('shelby', 'eli') returns "Your Mom"
</verification>

<success_criteria>
- familyStore has loadData, getMemberById, calculateRelationship, and generation selectors
- userStore has loadData, currentMemberId, and preferences
- Both stores have isLoading and error states
- Stores are exported from index.ts
- calculateRelationship takes currentUserId as parameter (caller supplies it from userStore)
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-foundation/01-02-SUMMARY.md`
</output>
